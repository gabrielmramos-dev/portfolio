---
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import Comments from '../../components/Comments.astro';
import { getAllPosts, getPostBySlug, getPageContent, blocksToHtml } from '../../lib/notion';

// Gera rotas estáticas para todos os posts
export async function getStaticPaths() {
  try {
    const posts = await getAllPosts();
    return posts.map((post) => ({
      params: { slug: post.slug },
    }));
  } catch (e) {
    console.error('Erro ao gerar paths:', e);
    return [];
  }
}

const { slug } = Astro.params;

// Busca o post
let post = null;
let content = '';
let error = null;

try {
  post = await getPostBySlug(slug!);
  if (post) {
    const blocks = await getPageContent(post.id);
    content = blocksToHtml(blocks);
  }
} catch (e) {
  error = 'Não foi possível carregar o post.';
  console.error('Erro ao buscar post:', e);
}

// Formata data
function formatDate(dateStr: string): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('pt-BR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
}
---

<!DOCTYPE html>
<html>
  <Header title={post ? `${post.title} | Blog | Gabriel Ramos` : 'Post não encontrado'} />
  <body>
    <div class="content">
      <Sidebar selectedItem="blog" />
      <nav class="main">
        <div class="container">
          <a href="/blog" class="back-nav-button">
            <div class="back-nav-container">
              <img src="/assets/back.svg" loading="eager" alt="" class="back-nav-img" />
              <div>Blog</div>
            </div>
          </a>

          {error || !post ? (
            <main class="fold-content-container">
              <div class="blog-error">
                <h1>Post não encontrado</h1>
                <p>O post que você está procurando não existe ou foi removido.</p>
                <a href="/blog" class="button w-button">Voltar para o Blog</a>
              </div>
            </main>
          ) : (
            <article class="blog-post">
              <header class="blog-post-header">
                <div class="blog-post-meta">
                  <time datetime={post.date}>{formatDate(post.date)}</time>
                  {post.tags.length > 0 && (
                    <div class="blog-post-tags">
                      {post.tags.map((tag) => (
                        <span class="blog-tag">{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
                <h1>{post.title}</h1>
                {post.description && (
                  <p class="blog-post-description">{post.description}</p>
                )}
              </header>

              <div class="blog-post-content" set:html={content} />

              <Comments />
            </article>
          )}
        </div>
      </nav>
    </div>
  </body>
</html>

<style>
  .blog-post {
    width: 100%;
  }

  .blog-post-header {
    margin-bottom: 48px;
    padding-bottom: 32px;
    border-bottom: 1px solid #353535;
  }

  .blog-post-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .blog-post-meta time {
    color: #a8a8a8;
    font-size: 14px;
    font-family: 'IBM Plex Mono', monospace;
  }

  .blog-post-tags {
    display: flex;
    gap: 8px;
  }

  .blog-tag {
    background-color: #353535;
    color: #fff;
    font-size: 12px;
    font-family: 'IBM Plex Mono', monospace;
    padding: 4px 10px;
    border-radius: 4px;
  }

  .blog-post-header h1 {
    font-size: 42px;
    line-height: 52px;
    margin-bottom: 16px;
  }

  .blog-post-description {
    color: #a8a8a8;
    font-size: 18px;
    line-height: 28px;
    margin: 0;
  }

  /* Estilos do conteúdo */
  .blog-post-content {
    color: #e0e0e0;
    font-size: 16px;
    line-height: 28px;
  }

  .blog-post-content :global(h1) {
    font-size: 32px;
    line-height: 42px;
    margin-top: 48px;
    margin-bottom: 16px;
  }

  .blog-post-content :global(h2) {
    font-size: 26px;
    line-height: 36px;
    margin-top: 40px;
    margin-bottom: 14px;
    color: #fff;
  }

  .blog-post-content :global(h3) {
    font-size: 20px;
    line-height: 30px;
    margin-top: 32px;
    margin-bottom: 12px;
    color: #fff;
  }

  .blog-post-content :global(p) {
    margin-bottom: 20px;
    color: #e0e0e0;
  }

  .blog-post-content :global(a) {
    color: #fff;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .blog-post-content :global(a:hover) {
    opacity: 0.8;
  }

  .blog-post-content :global(strong) {
    color: #fff;
    font-weight: 600;
  }

  .blog-post-content :global(code) {
    background-color: #2a2a2a;
    color: #f0f0f0;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
  }

  .blog-post-content :global(pre) {
    background-color: #1a1a1a;
    border: 1px solid #353535;
    border-radius: 8px;
    padding: 20px;
    overflow-x: auto;
    margin: 24px 0;
  }

  .blog-post-content :global(pre code) {
    background: none;
    padding: 0;
    font-size: 14px;
    line-height: 24px;
  }

  .blog-post-content :global(ul),
  .blog-post-content :global(ol) {
    padding-left: 24px;
    margin-bottom: 20px;
  }

  .blog-post-content :global(li) {
    margin-bottom: 8px;
    color: #e0e0e0;
  }

  .blog-post-content :global(blockquote) {
    border-left: 3px solid #a8a8a8;
    padding-left: 20px;
    margin: 24px 0;
    color: #a8a8a8;
    font-style: italic;
  }

  .blog-post-content :global(hr) {
    border: none;
    border-top: 1px solid #353535;
    margin: 40px 0;
  }

  .blog-post-content :global(figure) {
    margin: 32px 0;
  }

  .blog-post-content :global(figure img) {
    width: 100%;
    border-radius: 8px;
  }

  .blog-post-content :global(figcaption) {
    text-align: center;
    color: #a8a8a8;
    font-size: 14px;
    margin-top: 12px;
  }

  .blog-post-content :global(.callout) {
    display: flex;
    gap: 12px;
    background-color: rgba(53, 53, 53, 0.5);
    border: 1px solid #353535;
    border-radius: 8px;
    padding: 16px;
    margin: 24px 0;
  }

  .blog-post-content :global(.callout-icon) {
    font-size: 20px;
  }

  .blog-error {
    text-align: center;
    padding: 48px 24px;
  }

  .blog-error h1 {
    font-size: 32px;
    margin-bottom: 16px;
  }

  .blog-error p {
    color: #a8a8a8;
    margin-bottom: 24px;
  }

  @media screen and (max-width: 767px) {
    .blog-post-header h1 {
      font-size: 32px;
      line-height: 42px;
    }
  }
</style>
